<!DOCTYPE html>
<html>
  <head>
    <title>♫♪</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        margin-top: 84px;
      }
      .song-label {
        white-space: nowrap;
        text-shadow: -1px -1px #5cb85c, -1px 1px #5cb85c, 1px -1px #5cb85c, 1px 1px #5cb85c;
      }
    </style>
    <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="//fb.me/react-0.13.3.js"></script>
    <script src="//fb.me/JSXTransformer-0.13.3.js"></script>
    <script type="text/jsx">
      var Result = React.createClass({
        handleClick: function (event) {
          event.preventDefault();
          $.post("/playlist", { name: event.target.dataset.name, artist: event.target.dataset.artist });
        },
        render: function () {
          return <li><a href="#" onClick={this.handleClick} data-name={this.props.name} data-artist={this.props.artist}>
            {this.props.name + " - " + this.props.artist}
          </a></li>;
        }
      });

      var SearchBar = React.createClass({
        handleChange: function (event) {
          $.getJSON("/search?q=" + event.target.value, function (results) {
            if (!results) results = [];
            if (this.isMounted()) this.setState({ results: results.slice(0, 10) });
          }.bind(this));
        },
        getInitialState: function () {
          return { results: [] };
        },
        render: function () {
          var results = this.state.results.map(function (result) {
            return <Result key={Math.random().toString(36)} {...result} />;
          });
          return <nav className="navbar navbar-default navbar-fixed-top">
            <div className="container">
              <form className="navbar-form">
                <div className="input-group input-group-lg">
                  <span className="input-group-addon">
                    <span className="glyphicon glyphicon-search"></span>
                  </span>
                  <input ref="q" className="form-control" onChange={this.handleChange} placeholder="search for a song..." data-toggle="dropdown" />
                  {results.length > 0 ? <ul className="dropdown-menu">{results}</ul> : null}
                </div>
              </form>
            </div>
          </nav>;
        }
      });

      var Song = React.createClass({
        render: function () {
          return <div className="progress">
            <div className="progress-bar progress-bar-success progress-bar-striped active song-label" style={{ width: '0%' }}>
              {this.props.name + " - " + this.props.artist}
            </div>
          </div>;
        }
      });

      var Playlist = React.createClass({
        loadPlaylistFromServer: function () {
          $.getJSON("/playlist", function (playlist) {
            if (!playlist) playlist = [];
            if (this.isMounted()) this.setState({ playlist: playlist });
          }.bind(this));
        },
        getInitialState: function () {
          return { playlist: [] };
        },
        componentDidMount: function () {
          this.loadPlaylistFromServer();
          setInterval(this.loadPlaylistFromServer, 5000);
        },
        render: function () {
          return <div className="container">
            {this.state.playlist.map(function (song) {
              return <Song key={song.ID} name={song.Name} artist={song.Artist} />;
            })}
          </div>;
        }
      });

      React.render(<body><SearchBar /><Playlist /></body>, document.body);
    </script>
  </head>
</html>
